<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <title>Tradutor PT-BR para LIBRAS</title>
    <link rel="stylesheet" href="/static/style.css">

</head>

<body>
    <div class="container">
        <div class="header">
            <img id="app-logo" src="/static/logo_claro.png" alt="Logo Libre-se">
            <button id="theme-toggle-btn" aria-label="Alternar tema">☀︎</button>
        </div>

        <div class="translation-interface">
            <div class="input-area">
                <select>
                    <option>Português (Brasil)</option>
                </select>
                <textarea id="texto-pt" placeholder="Digite aqui..."></textarea>
                <div class="buttons">
                    <button id="apagar" type="button">Apagar</button>
                    <button id="traduzir" type="button">Traduzir</button>
                </div>
            </div>

            <div class="output-area">
                <select>
                    <option>Língua Brasileira de Sinais (LIBRAS)</option>
                </select>
                <div class="resultado" id="libras-output">

                </div>

            </div>
        </div>
    </div>
    <div class="footer">
        Desenvolvido por Grupo 04 • Inspirado no VLIBRAS • CESAR © 2025
    </div>
    <script>
        function normalizeToken(s) {
            return s
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                .replace(/[^\p{L}\p{N}\s]/gu, '')
                .trim()
                .toLowerCase();
        }

        async function existsHead(url) {
            try {
                const res = await fetch(url, { method: 'HEAD' });
                return res.ok;
            } catch (e) {
                return await existsByLoading(url);
            }
        }

        function existsByLoading(url, timeout = 3000) {
            return new Promise(resolve => {
                const img = new Image();
                let done = false;
                const finish = (val) => { if (!done) { done = true; resolve(val); } };
                const t = setTimeout(() => finish(false), timeout);
                img.onload = () => { clearTimeout(t); finish(true); };
                img.onerror = () => { clearTimeout(t); finish(false); };
                img.src = url;
            });
        }

        function renderMedia(container, url) {
            const lower = url.toLowerCase();
            if (lower.endsWith('.gif') || lower.endsWith('.webp')) {
                const img = document.createElement('img');
                img.src = url;
                img.alt = 'GIF Libras';
                img.loading = 'lazy';
                container.appendChild(img);
            } else if (lower.endsWith('.mp4') || lower.endsWith('.webm') || lower.includes('video')) {
                const v = document.createElement('video');
                v.src = url;
                v.autoplay = true;
                v.loop = true;
                v.muted = true;
                v.controls = true;
                container.appendChild(v);
            } else {
                const a = document.createElement('a');
                a.href = url;
                a.target = '_blank';
                a.rel = 'noopener noreferrer';
                a.textContent = 'Abrir recurso de Libras';
                container.appendChild(a);
            }
        }


        const output = document.getElementById('libras-output');
        const STATIC_BASE = window.location.origin + '/static/Gifs/';
        const MAX_NGRAM = 4;

        async function findGifsGreedy(text) {
            const norm = normalizeToken(text);
            if (!norm) return [];
            const words = norm.split(/\s+/).filter(Boolean);
            const results = [];
            let i = 0;
            while (i < words.length) {
                let matched = false;
                const maxN = Math.min(MAX_NGRAM, words.length - i);
                for (let n = maxN; n >= 1; n--) {
                    const slice = words.slice(i, i + n);
                    const phrase = slice.join(' ');

                    const candidates = [
                        `${STATIC_BASE}${encodeURIComponent(phrase)}.gif`,
                        `${STATIC_BASE}${encodeURIComponent(phrase.replace(/\s+/g, '_'))}.gif`,
                        `${STATIC_BASE}${encodeURIComponent(phrase.replace(/\s+/g, ''))}.gif`
                    ];
                    for (const c of candidates) {
                        if (await existsHead(c)) {
                            results.push({ phrase, url: c });
                            matched = true;
                            break;
                        }
                    }
                    if (matched) {
                        i += n;
                        break;
                    }
                }
                if (!matched) {
                    i += 1;
                }
            }
            return results;
        }


        document.getElementById('apagar').addEventListener('click', () => {
            document.getElementById('texto-pt').value = '';
            output.innerHTML = '';

        });

        document.getElementById('traduzir').addEventListener('click', async () => {
            const texto = document.getElementById('texto-pt').value || '';
            if (!texto.trim()) return alert('Digite um texto!');
            output.innerHTML = '<div class="placeholder">Procurando GIFs locais…</div>';

            const found = await findGifsGreedy(texto);

            output.innerHTML = '';
            if (found.length > 0) {
                // renderizar na ordem
                found.forEach(it => renderMedia(output, it.url));
                return;
            }

            // fallback: chamar backend
            output.innerHTML = '<div class="placeholder">Nenhum GIF local encontrado — consultando a API...</div>';
            try {
                const resp = await fetch('/traduzir_texto', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ texto })
                });
                if (!resp.ok) {
                    const txt = await resp.text().catch(() => resp.statusText);
                    output.innerHTML = `<div class="placeholder">Erro do servidor: ${resp.status} — ${txt}</div>`;
                    return;
                }
                const data = await resp.json();
                output.innerHTML = '';
                if (Array.isArray(data.videos) && data.videos.length) {
                    data.videos.forEach(url => {
                        if (url.startsWith('/')) url = window.location.origin + url;
                        renderMedia(output, url);
                    });
                    return;
                }
                if (data.fileUrl) {
                    let url = data.fileUrl;
                    if (url.startsWith('/')) url = window.location.origin + url;
                    renderMedia(output, url);
                    return;
                }
                output.innerHTML = '<div class="placeholder">Nenhum resultado recebido da API.</div>';
            } catch (err) {
                output.innerHTML = `<div class="placeholder">Erro na chamada: ${err.message}</div>`;
            }
        });

        /* ---------------------
           Toggle de Tema (claro / escuro)
           --------------------- */
        (function initThemeToggle() {
            const toggleBtn = document.getElementById('theme-toggle-btn');
            if (!toggleBtn) return;
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                toggleBtn.textContent = '☾';
            } else {
                toggleBtn.textContent = '☀︎';
            }

            toggleBtn.addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');

                if (document.body.classList.contains('dark-mode')) {
                    localStorage.setItem('theme', 'dark');
                    toggleBtn.textContent = '☾';
                } else {
                    localStorage.setItem('theme', 'light');
                    toggleBtn.textContent = '☀︎';
                }
            });
        })();
    </script>
</body>

</html>